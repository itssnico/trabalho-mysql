-- 1) CREATE DATABASE -------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE DATABASE IF NOT EXISTS TRABALHO;

USE TRABALHO;

-- 2) CREATE TABLES -------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS TRABALHO.ALUNO(
 RA INT UNSIGNED NOT NULL AUTO_INCREMENT,
 NOME_ALUNO VARCHAR(250) NOT NULL,
 SEXO_ALUNO VARCHAR(1) NOT NULL COMMENT "F - FEMININO / M - MASCULINO",
 CONSTRAINT PK_ALUNO PRIMARY KEY (RA)
)ENGINE = InnoDB AUTO_INCREMENT = 12340 CHARSET = UTF8;


CREATE TABLE IF NOT EXISTS TRABALHO.PROFESSOR (
  MATRICULA INT UNSIGNED NOT NULL AUTO_INCREMENT,
  NOME_PROFESSOR VARCHAR(50) NOT NULL,
  TITULACAO VARCHAR(50) NOT NULL,
  SEXO_PROFESSOR VARCHAR(1) COMMENT "F - FEMININO / M - MASCULINO",
  CONSTRAINT PK_PROFESSOR PRIMARY KEY(MATRICULA)
)ENGINE = InnoDB AUTO_INCREMENT = 1000 CHARSET = UTF8;


CREATE TABLE IF NOT EXISTS TRABALHO.TURMA (
  NUM_TURMA INT UNSIGNED NOT NULL,
  DTA_INICIO_AULAS DATE NOT NULL,
  DTA_FIM_AULA DATE NOT NULL,
  CONSTRAINT PK_TURMA PRIMARY KEY(NUM_TURMA)
)ENGINE = InnoDB CHARSET = UTF8;


CREATE TABLE IF NOT EXISTS TRABALHO.DISCIPLINA (
  COD_DISCIPLINA INT UNSIGNED NOT NULL,
  NOM_DISCIPLINA VARCHAR(250) NOT NULL,
  CARGA_HORARIA INT NOT NULL,
  CONSTRAINT PK_DISCIPLINA PRIMARY KEY(COD_DISCIPLINA)
)ENGINE = InnoDB CHARSET = UTF8;


CREATE TABLE IF NOT EXISTS TRABALHO.MATRICULA(
  NUM_MATRICULA INT UNSIGNED NOT NULL AUTO_INCREMENT,
  DTA_MATRICULA DATE NOT NULL,
  DTA_CANCELAMENTO_MATRICULA DATE,
  RA INT UNSIGNED NOT NULL,
  NUM_TURMA INT UNSIGNED NOT NULL,
  CONSTRAINT PK_MATRICULA PRIMARY KEY(NUM_MATRICULA),
  CONSTRAINT FK_MATRICULA_ALUNO FOREIGN KEY (RA) REFERENCES TRABALHO.ALUNO(RA),
  CONSTRAINT FK_MATRICULA_TURMA FOREIGN KEY (NUM_TURMA) REFERENCES TRABALHO.TURMA(NUM_TURMA)
)ENGINE = InnoDB CHARSET = UTF8;


CREATE TABLE IF NOT EXISTS TRABALHO.DISCIPLINA_OFERECIDA (
  NUM_DISCIPLINA_OFERECIDA INT UNSIGNED NOT NULL,
  SALA VARCHAR(10) NOT NULL,
  BLOCO VARCHAR(10) NOT NULL,
  DIA_SEMANA INT NOT NULL COMMENT "DEVE ESTAR ENTRE 1-DOMINGO E 7-SABADO",
  HOR_INICIO TIME NOT NULL,
  HOR_FIM TIME NOT NULL,
  MATRICULA INT UNSIGNED NOT NULL,
  NUM_TURMA INT UNSIGNED NOT NULL,
  COD_DISCIPLINA INT UNSIGNED NOT NULL,
  CONSTRAINT PK_DISCIPLINA_OFERECIDA PRIMARY KEY(NUM_DISCIPLINA_OFERECIDA),
  CONSTRAINT FK_OFERECIDA_MATRICULA FOREIGN KEY(MATRICULA) REFERENCES TRABALHO.PROFESSOR(MATRICULA),
  CONSTRAINT FK_OFERECIDA_TURMA FOREIGN KEY(NUM_TURMA) REFERENCES TRABALHO.TURMA(NUM_TURMA),
  CONSTRAINT FK_OFERECIDA_DISCIPLINA FOREIGN KEY(COD_DISCIPLINA) REFERENCES TRABALHO.DISCIPLINA(COD_DISCIPLINA)
)ENGINE = InnoDB CHARSET = UTF8;


CREATE TABLE IF NOT EXISTS TRABALHO.AVALIACAO(
  SEQ_AVALIACAO_ALUNO INT UNSIGNED NOT NULL AUTO_INCREMENT,
  NOTA_A2 DECIMAL(5,2) NOT NULL COMMENT "DEVE ESTAR ENTRE 0 E 5",
  NOTA_A1 DECIMAL(5,2) COMMENT "DEVE ESTAR ENTRE 0 E 5",
  NOTA_AF DECIMAL(5,2) COMMENT "DEVE ESTAR ENTRE 0 E 5",
  RA INT UNSIGNED NOT NULL,
  NUM_DISCIPLINA_OFERECIDA INT UNSIGNED NOT NULL,
  CONSTRAINT PK_AVALIACAO PRIMARY KEY(SEQ_AVALIACAO_ALUNO),
  CONSTRAINT FK_AVALIACAO_ALUNO FOREIGN KEY(RA) REFERENCES TRABALHO.ALUNO(RA),
  CONSTRAINT FK_AVALIACAO_DISCIPLINA_OFERECIDA FOREIGN KEY(NUM_DISCIPLINA_OFERECIDA) REFERENCES TRABALHO.DISCIPLINA_OFERECIDA(NUM_DISCIPLINA_OFERECIDA)
)ENGINE = InnoDB CHARSET = UTF8;


-- 3) INSERTS -------------------------------------------------------------------------------------------------------------------------------------------------------
-- 3.1)
-- 3.1.1)
INSERT INTO TRABALHO.TURMA (NUM_TURMA,DTA_INICIO_AULAS,DTA_FIM_AULA)
VALUES (1,"2022-08-01","2022-12-20"), (2,"2023-02-13","2023-06-30");

-- 3.1.2)
INSERT INTO TRABALHO.ALUNO (NOME_ALUNO,SEXO_ALUNO)
VALUES ("BEATRICE A. MCCORMICK","F"), ("RONAN H. RATLIFF","M"), ("ERICA O. SNIDER","F"), ("WESLEY F. AVERY","M"), ("AUDREY G. GREGORY","M"), 
("HONORATO B. AYALA","M"), ("OCTAVIA B. BURTON","F"), ("HERMAN I. WALSH","M"), ("CLINTON Q. BRADY","M"), ("ALFONSO H. PARK","M"),
("MAITE F. JORDAN","F"), ("JIN A. FLOWERS","M"), ("DORIAN R. DUDLEY","F"), ("SIMONE R. BULLOCK","F"), ("MADELINE A. SHEPARD","F"), 
("BRIAN H. NIXON","M"), ("LEONARD L. HOUSE","M"), ("GEOFFREY C. BOND","M"), ("STACEY G. NOBLE","F"), ("LARISSA N. MCLAUGHLIN","F");

-- 3.1.3)
INSERT INTO TRABALHO.PROFESSOR (NOME_PROFESSOR, TITULACAO, SEXO_PROFESSOR)
VALUES ("Alexandre Leite Rangel","Mestre","M"), ("Eduardo Alves de Freitas","Mestre","M"), ("Josefa Vanessa Martins","Mestre","F"), ("Andrea Martins Cristóvão","Mestre","F");

-- 3.1.4)
INSERT INTO TRABALHO.DISCIPLINA (COD_DISCIPLINA,NOM_DISCIPLINA,CARGA_HORARIA)
VALUES (1,"Banco de Dados",60),(2,"Engenharia de software",60),(3,"Técnicas de programação",60),(4,"Análise e projeto de Sistemas",60);

-- 3.2)
-- 3.2.1) 
INSERT INTO TRABALHO.MATRICULA (DTA_MATRICULA,DTA_CANCELAMENTO_MATRICULA,RA,NUM_TURMA)
VALUES ("2022-07-01",NULL,12340,1), ("2022-07-02",NULL,12341,1), ("2022-07-03",NULL,12342,1), ("2022-07-04",NULL,12343,1), ("2022-07-05",NULL,12344,1), 
("2022-07-06",NULL,12345,1), ("2022-07-07",NULL,12346,1), ("2022-07-08",NULL,12347,1), ("2022-07-09",NULL,12348,1), ("2022-07-10",NULL,12349,1),
("2023-01-01",NULL,12350,2), ("2023-01-02",NULL,12351,2), ("2023-01-03",NULL,12352,2), ("2023-01-04",NULL,12353,2), ("2023-01-05",NULL,12354,2), 
("2023-01-06",NULL,12355,2), ("2023-01-07",NULL,12356,2), ("2023-01-08",NULL,12357,2), ("2023-01-09",NULL,12358,2), ("2023-01-10",NULL,12359,2);

-- 3.2.2)
INSERT INTO TRABALHO.DISCIPLINA_OFERECIDA (NUM_DISCIPLINA_OFERECIDA, SALA, BLOCO, DIA_SEMANA, HOR_INICIO, HOR_FIM, MATRICULA, NUM_TURMA, COD_DISCIPLINA)
VALUES (1, "8", "A", 3, "19:10:00", "21:50:00", 1000, 1, 1),(2, "102", "C", 2, "19:10:00", "21:50:00", 1001, 1, 2),(3, "8", "A", 4, "19:10:00", "21:50:00", 1002, 1, 3),(4, "102", "C", 5, "19:10:00", "21:50:00", 1003, 1, 4),
(5, "8", "A", 3, "19:10:00", "21:50:00", 1000, 2, 1),(6, "102", "C", 2, "19:10:00", "21:50:00", 1001, 2, 2),(7, "8", "A", 4, "19:10:00", "21:50:00", 1002, 2, 3),(8, "102", "C", 5, "19:10:00", "21:50:00", 1003, 2, 4);

-- 3.2.3) 
-- Turma a
INSERT INTO TRABALHO.AVALIACAO (NOTA_A2, NOTA_A1, NOTA_AF, RA, NUM_DISCIPLINA_OFERECIDA)
VALUES (0, 0, NULL, 12340, 1),(0, 0, NULL, 12340, 2),(0, 0, NULL, 12340, 3),(0, 0, NULL, 12340, 4),
(3, 4.5, NULL, 12341, 1),(2.75, 3, NULL, 12341, 2),(3, 3, NULL, 12341, 3),(5, 4.5, NULL, 12341, 4),
(3.25, 4, NULL, 12342, 1),(3.75, 3.25, NULL, 12342, 2),(2, 4, NULL, 12342, 3),(5, 2, NULL, 12342, 4),
(4.25, 4, NULL, 12343, 1),(4.75, 1.25, NULL, 12343, 2),(5, 4, NULL, 12343, 3),(3, 3.75, NULL, 12343, 4),
(3.75, 3, NULL, 12344, 1),(3, 3.25, NULL, 12341, 2),(4, 4, NULL, 12341, 3),(4, 3, NULL, 12341, 4),
(3.75, 1, 4, 12345, 1),(3, 2, 4, 12345, 2),(2, 3, 3, 12345, 3),(1, 3, 3, 12345, 4),
(3, 1.25, 3, 12346, 1),(3, 2, 4, 12346, 2),(2, 2.25, 4, 12346, 3),(1, 3, 3.25, 12346, 4),
(2, 1.75, 1, 12347, 1),(3, 2.5, 2, 12347, 2),(2, 3.25, 1, 12347, 3),(1, 3, 2.5, 12347, 4),
(2, 0.75, 5, 12348, 1),(1, 2.5, 4, 12348, 2),(2, 3, 3.5, 12348, 3),(2, 3, 3.75, 12348, 4),
(1, 1.25, 2, 12349, 1),(2, 2.25, 2, 12349, 2),(2, 1, 1, 12349, 3),(2, 0.25, 2.25, 12349, 4);

-- 3.2.4) ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Turma B
INSERT INTO TRABALHO.AVALIACAO (NOTA_A2, NOTA_A1, NOTA_AF, RA, NUM_DISCIPLINA_OFERECIDA)
VALUES (0, 0.5, NULL, 12350, 1),(0, 0.25, NULL, 12350, 2),(0, 0, NULL, 12350, 3),(0, 0.25, NULL, 12350, 4),
(3, 5, NULL, 12351, 1),(4, 3, NULL, 12351, 2),(3, 4, NULL, 12351, 3),(5, 5, NULL, 12351, 4),
(3.25, 4, NULL, 12352, 1),(3, 3.25, NULL, 12352, 2),(2.5, 4, NULL, 12352, 3),(5, 2, NULL, 12352, 4),
(4.25, 4, NULL, 12353, 1),(4.75, 1.25, NULL, 12353, 2),(5, 4, NULL, 12353, 3),(3, 3.75, NULL, 12353, 4),
(3.75, 3, NULL, 12354, 1),(3, 4.25, NULL, 12354, 2),(4, 3, NULL, 12354, 3),(4, 3, NULL, 12354, 4),
(3.75, 1, NULL, 12355, 1),(3, 2, NULL, 12355, 2),(2, 3, NULL, 12355, 3),(1, 3, NULL, 12355, 4),
(3, 1.25, NULL, 12356, 1),(3, 2, NULL, 12356, 2),(2, 3.25, NULL, 12356, 3),(1, 3, NULL, 12356, 4),
(2, 1.75, NULL, 12357, 1),(3, 2.5, NULL, 12357, 2),(2, 3.25, NULL, 12357, 3),(1, 3, NULL, 12357, 4),
(3, 0.75, NULL, 12358, 1),(2.5, 2.5, NULL, 12358, 2),(2, 3.25, NULL, 12358, 3),(1, 3, NULL, 12358, 4),
(2, 0.75, NULL, 12359, 1),(1, 2.5, NULL, 12359, 2),(2, 3, NULL, 12359, 3),(2, 3, NULL, 12359, 4);

-- 4) SELECT ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 4.1) 
SELECT PRO.NOME_PROFESSOR 'PROFESSOR', PRO.TITULACAO 'TÍTULO', CASE DOF.NUM_DISCIPLINA_OFERECIDA
    WHEN 1 THEN 'Banco de dados'
    WHEN 2 THEN 'Engenharia de software'
    WHEN 3 THEN 'Técnicas de programação'
    WHEN 4 THEN 'Análise e projeto de Sistemas'
    WHEN 5 THEN 'Banco de dados'
    WHEN 6 THEN 'Engenharia de software'
    WHEN 7 THEN 'Técnicas de programação'
    WHEN 8 THEN 'Análise e projeto de Sistemas'
    ELSE 'Erro'
END DISCIPLINA, 
DTA_INICIO_AULAS 'INICIO AULAS', DTA_FIM_AULA 'FIM AULA',COUNT(MTR.RA) 
'QTDE ALUNOS', DOF.BLOCO, DOF.SALA, 
CASE DOF.DIA_SEMANA
	WHEN 2 THEN "Segunda"
    WHEN 3 THEN "Terça"
    WHEN 4 THEN "Quarta"
    WHEN 5 THEN "Quinta"
    WHEN 6 THEN "Sexta"
    ELSE 'Erro'
END SEMANA, 
DOF.HOR_INICIO 'HORÁRIO INICIO', DOF.HOR_FIM 'HORÁRIO FIM'
FROM TRABALHO.PROFESSOR PRO
JOIN TRABALHO.DISCIPLINA_OFERECIDA DOF ON PRO.MATRICULA = DOF.MATRICULA
JOIN TRABALHO.TURMA TUR ON DOF.NUM_TURMA = TUR.NUM_TURMA
JOIN TRABALHO.MATRICULA MTR ON TUR.NUM_TURMA = MTR.NUM_TURMA
GROUP BY DOF.NUM_DISCIPLINA_OFERECIDA
ORDER BY PRO.NOME_PROFESSOR;

-- 4.2) 
SELECT DIS.NOM_DISCIPLINA 'DISCIPLINA', PRO.NOME_PROFESSOR 'PROFESSOR', DOF.BLOCO, DOF.SALA,
CASE DOF.DIA_SEMANA
	WHEN 2 THEN "Segunda"
    WHEN 3 THEN "Terça"
    WHEN 4 THEN "Quarta"
    WHEN 5 THEN "Quinta"
    WHEN 6 THEN "Sexta"
    ELSE 'Erro'
END SEMANA,
DOF.HOR_INICIO 'HORÁRIO INICIO', DOF.HOR_FIM 'HORÁRIO FIM', MTR.RA, ALN.NOME_ALUNO 'NOME'
FROM TRABALHO.DISCIPLINA DIS
JOIN TRABALHO.DISCIPLINA_OFERECIDA DOF ON DIS.COD_DISCIPLINA = DOF.COD_DISCIPLINA
JOIN TRABALHO.PROFESSOR PRO ON DOF.MATRICULA = PRO.MATRICULA
JOIN TRABALHO.TURMA TUR ON DOF.NUM_TURMA = TUR.NUM_TURMA
JOIN TRABALHO.MATRICULA MTR ON TUR.NUM_TURMA = MTR.NUM_TURMA
JOIN TRABALHO.ALUNO ALN ON MTR.RA = ALN.RA
WHERE TUR.NUM_TURMA = 2
GROUP BY MTR.RA, PRO.NOME_PROFESSOR
ORDER BY DIS.NOM_DISCIPLINA;

-- 4.3)
-- TURMA A
SELECT DIS.NOM_DISCIPLINA 'DISCIPLINA', PRO.NOME_PROFESSOR 'PROFESSOR', DOF.BLOCO, DOF.SALA,
CASE DOF.DIA_SEMANA
	WHEN 2 THEN "Segunda"
    WHEN 3 THEN "Terça"
    WHEN 4 THEN "Quarta"
    WHEN 5 THEN "Quinta"
    WHEN 6 THEN "Sexta"
    ELSE 'Erro'
END SEMANA,
DOF.HOR_INICIO 'HORÁRIO INICIO', DOF.HOR_FIM 'HORÁRIO FIM', MTR.RA, ALN.NOME_ALUNO 'NOME',
AVL.NOTA_A2 'NOTA A2', AVL.NOTA_A1 'NOTA A1', AVL.NOTA_AF 'NOTA AF',
CASE 
    WHEN ((IFNULL(AVL.NOTA_AF,0) >= AVL.NOTA_A2) OR (IFNULL(AVL.NOTA_AF,0) >= AVL.NOTA_A1) AND (AVL.NOTA_A2 >= AVL.NOTA_A1)) AND (IFNULL(AVL.NOTA_AF,0) + AVL.NOTA_A2) >=6 THEN 'APROVADO'
    WHEN ((IFNULL(AVL.NOTA_AF,0) >= AVL.NOTA_A1) OR (IFNULL(AVL.NOTA_AF,0) >= AVL.NOTA_A2) AND (AVL.NOTA_A1 >= AVL.NOTA_A2)) AND (IFNULL(AVL.NOTA_AF,0) + AVL.NOTA_A1) >=6 THEN 'APROVADO'
    WHEN AVL.NOTA_A2 + AVL.NOTA_A1 >= 6 THEN 'APROVADO' 
    ELSE 'REPROVADO'
END 'SITUAÇÃO ALUNO'
FROM TRABALHO.DISCIPLINA DIS
JOIN TRABALHO.DISCIPLINA_OFERECIDA DOF ON DIS.COD_DISCIPLINA = DOF.COD_DISCIPLINA
JOIN TRABALHO.PROFESSOR PRO ON DOF.MATRICULA = PRO.MATRICULA
JOIN TRABALHO.TURMA TUR ON DOF.NUM_TURMA = TUR.NUM_TURMA
JOIN TRABALHO.MATRICULA MTR ON TUR.NUM_TURMA = MTR.NUM_TURMA
JOIN TRABALHO.ALUNO ALN ON MTR.RA = ALN.RA
JOIN TRABALHO.AVALIACAO AVL ON ALN.RA = AVL.RA
WHERE TUR.NUM_TURMA = 1
GROUP BY MTR.RA, PRO.NOME_PROFESSOR
ORDER BY DIS.NOM_DISCIPLINA;

-- TURMA B
SELECT DIS.NOM_DISCIPLINA 'DISCIPLINA', PRO.NOME_PROFESSOR 'PROFESSOR', DOF.BLOCO, DOF.SALA,
CASE DOF.DIA_SEMANA
	WHEN 2 THEN "Segunda"
    WHEN 3 THEN "Terça"
    WHEN 4 THEN "Quarta"
    WHEN 5 THEN "Quinta"
    WHEN 6 THEN "Sexta"
    ELSE 'Erro'
END SEMANA,
DOF.HOR_INICIO 'HORÁRIO INICIO', DOF.HOR_FIM 'HORÁRIO FIM', MTR.RA, ALN.NOME_ALUNO 'NOME',
AVL.NOTA_A2 'NOTA A2', AVL.NOTA_A1 'NOTA A1', AVL.NOTA_AF 'NOTA AF',
CASE 
	WHEN AVL.NOTA_A2 + AVL.NOTA_A1 < 1 THEN 'REPROVADO'
    WHEN AVL.NOTA_A2 + AVL.NOTA_A1 >= 6 THEN 'APROVADO'
    WHEN AVL.NOTA_A2 + AVL.NOTA_A1 > 1 AND AVL.NOTA_A2 + AVL.NOTA_A1 < 5.75 THEN 'AVALIAÇÃO FINAL'
    ELSE 'ERRO'
END 'SITUAÇÃO ALUNO'
FROM TRABALHO.DISCIPLINA DIS
JOIN TRABALHO.DISCIPLINA_OFERECIDA DOF ON DIS.COD_DISCIPLINA = DOF.COD_DISCIPLINA
JOIN TRABALHO.PROFESSOR PRO ON DOF.MATRICULA = PRO.MATRICULA
JOIN TRABALHO.TURMA TUR ON DOF.NUM_TURMA = TUR.NUM_TURMA
JOIN TRABALHO.MATRICULA MTR ON TUR.NUM_TURMA = MTR.NUM_TURMA
JOIN TRABALHO.ALUNO ALN ON MTR.RA = ALN.RA
JOIN TRABALHO.AVALIACAO AVL ON ALN.RA = AVL.RA
WHERE TUR.NUM_TURMA = 2
GROUP BY ALN.RA, PRO.NOME_PROFESSOR, DIS.NOM_DISCIPLINA
ORDER BY DIS.NOM_DISCIPLINA;

-- 4.4)
SELECT DIS.NOM_DISCIPLINA 'DISCIPLINA', PRO.NOME_PROFESSOR 'PROFESSOR', PRO.TITULACAO, DOF.BLOCO, 
DOF.SALA, DOF.HOR_INICIO 'HORÁRIO INICIO', DOF.HOR_FIM 'HORÁRIO FIM', COUNT(DISTINCT MTR.DTA_MATRICULA) 
'MATRICULADOS', COUNT(DISTINCT MTR.DTA_CANCELAMENTO_MATRICULA) 'MATRÍCULAS CANCELADAS',
COUNT(DISTINCT AVL.NOTA_A2 + AVL.NOTA_A1 ) >= 6 'APROVADOS DIRETO',
COUNT(DISTINCT AVL.NOTA_A2 + AVL.NOTA_A1 ) <= 6 'REPROVADOS DIRETO',
CASE
	WHEN AVL.NOTA_A2 + AVL.NOTA_A1 <= 6 OR AVL.NOTA_A2 + AVL.NOTA_A1  >= 1 AND IFNULL(AVL.NOTA_AF,0) THEN COUNT(IFNULL(AVL.NOTA_AF,0))
    ELSE 0
END 'ALUNOS AF'
FROM TRABALHO.DISCIPLINA DIS
JOIN TRABALHO.DISCIPLINA_OFERECIDA DOF ON DIS.COD_DISCIPLINA = DOF.COD_DISCIPLINA
JOIN TRABALHO.PROFESSOR PRO ON DOF.MATRICULA = PRO.MATRICULA
JOIN TRABALHO.TURMA TUR ON DOF.NUM_TURMA = TUR.NUM_TURMA
JOIN TRABALHO.MATRICULA MTR ON TUR.NUM_TURMA = MTR.NUM_TURMA
JOIN TRABALHO.ALUNO ALN ON MTR.RA = ALN.RA
JOIN TRABALHO.AVALIACAO AVL ON ALN.RA = AVL.RA
GROUP BY DOF.NUM_DISCIPLINA_OFERECIDA
ORDER BY DIS.NOM_DISCIPLINA;

SELECT
  DIS.NOM_DISCIPLINA 'DISCIPLINA', PRO.NOME_PROFESSOR 'PROFESSOR', PRO.TITULACAO 'TÍTULO',
  DOF.SALA 'SALA', DOF.BLOCO 'BLOCO', DOF.HOR_INICIO 'HORARIO INICIO', DOF.HOR_FIM 'HORARIO FIM',
  ( SELECT COUNT(*) FROM MATRICULA WHERE MTR.NUM_MATRICULA = DOF.NUM_TURMA
    AND MTR.DTA_MATRICULA IS NOT NULL) 'MATRICULADOS',
  ( SELECT count(*) FROM MATRICULA WHERE MTR.NUM_TURMA = DOF.NUM_TURMA
	AND MTR.DTA_CANCELAMENTO_MATRICULA IS NOT NULL) AS 'MATRICULAS CANCELADAS',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA
	AND (NOTA_A1 + NOTA_A2) >= 6) AS 'APROVADOS DIREITO',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA
	AND (NOTA_A1 + NOTA_A2) >= 6) /
  ( SELECT COUNT(*) FROM AVALIACAO WHERE AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) * 100 '% APROVADOS DIRETO',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE (NOTA_A1 + NOTA_A2) < 1
	AND AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) 'REPROVADOS DIRETO',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE (NOTA_A1 + NOTA_A2) < 1
	AND AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) / 
  ( SELECT COUNT(*) FROM AVALIACAO WHERE
      AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) * 100 '% REPROVADO DIREITO',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE NOTA_AF IS NOT NULL
	AND AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) 'ALUNOS AF',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE NOTA_AF IS NOT NULL
	AND AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) / 
  ( SELECT COUNT(*) FROM AVALIACAO WHERE AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) * 100 '% ALUNOS AF',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE NOTA_AF IS NOT NULL AND ((NOTA_A1 + NOTA_AF) >= 6 OR (NOTA_A2 + NOTA_AF) >= 6)
	AND AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) 'APROVADOS AF',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE NOTA_AF IS NOT NULL AND ((NOTA_A1 + NOTA_AF) < 6 AND (NOTA_A2 + NOTA_AF) < 6)
	AND AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) 'REPROVADOS AF',
  ( SELECT COUNT(*) FROM AVALIACAO WHERE NOTA_AF IS NOT NULL AND ((NOTA_A1 + NOTA_AF) < 6 AND (NOTA_A2 + NOTA_AF) < 6)
	AND AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA) / 
  ( SELECT count(*) FROM AVALIACAO WHERE AVL.NUM_DISCIPLINA_OFERECIDA = DOF.NUM_DISCIPLINA_OFERECIDA
	AND (NOTA_A1 + NOTA_A2) > 1 AND (NOTA_A1 + NOTA_A2) < 6) * 100 ' % REPROVADOS AF'
FROM TRABALHO.DISCIPLINA DIS
JOIN TRABALHO.DISCIPLINA_OFERECIDA DOF ON DIS.COD_DISCIPLINA = DOF.COD_DISCIPLINA
JOIN TRABALHO.PROFESSOR PRO ON DOF.MATRICULA = PRO.MATRICULA
JOIN TRABALHO.TURMA TUR ON DOF.NUM_TURMA = TUR.NUM_TURMA
JOIN TRABALHO.MATRICULA MTR ON TUR.NUM_TURMA = MTR.NUM_TURMA
JOIN TRABALHO.ALUNO ALN ON MTR.RA = ALN.RA
JOIN TRABALHO.AVALIACAO AVL ON ALN.RA = AVL.RA
WHERE TUR.NUM_TURMA = 2
GROUP BY MTR.RA, PRO.NOME_PROFESSOR
ORDER BY DIS.NOM_DISCIPLINA;